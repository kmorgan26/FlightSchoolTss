@using AutoMapper;
@using FlightSchoolTss.DTOs.Maintainer;
@using FlightSchoolTss.Data.DTOs.Abstractions;
@using FlightSchoolTss.Data.Validation;
@using FlightSchoolTss.Data.Validators.Maintainer;
@using FluentValidation;

@inject IMapper Mapper
@inject ISnackbar Snackbar
@inject IMaintainersApiClient MaintainersApiClient
@inject NavigationManager navigation

<MudGrid Style="align-items: center">
    <MudItem xs="6">
        <MudForm Model="@_dto" @ref="@_mudForm" Validation="_validator.ValidateValue" ValidationDelay="0">

            <MudTextField @bind-Value="_dto.Name"
                          Variant="Variant.Outlined"
                          For="(() => _dto.Name)"
                          Label="Maintainer Name"
                          Class="my-6" />
        </MudForm>
    </MudItem>
    <MudItem xs="2">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(async () => await CreateOrInsertAsync())">@ButtonText</MudButton>
    </MudItem>
</MudGrid>

@code {

    [Parameter]
    public EventCallback OnMaintainerAdd { get; set; }

    [Parameter]
    public MaintainerDto _dto { get; set; } = new();

    [Parameter]
    public string ButtonText { get; set; } = "ADD";

    private MudForm? _mudForm;

    MaintainerDtoValidator _validator = new();

    private async Task CreateOrInsertAsync()
    {
        await _mudForm!.Validate();
        if (_mudForm.IsValid)
        {
            string operation = string.Empty;
            if (_dto.Id == 0)
            {
                operation = "added";
                var dto = Mapper.Map(_dto, new CreateMaintainerDto());
                await MaintainersApiClient.CreateMaintainerAsync(dto);
            }
            else
            {
                operation = "updated";
                var vm = Mapper.Map(_dto, new MaintainerVm());
                await MaintainersApiClient.UpdateMaintainerAsync(vm);
            }
            await OnMaintainerAdd.InvokeAsync();
            await _mudForm.ResetAsync();
            _dto = new();
            Snackbar.Add($"The Maintainer was Successfully {operation}!", MudBlazor.Severity.Success);
        }
    }
}