@page "/mode"

@inherits FluxorComponent

@inject IDispatcher Dispatcher
@inject IState<ModeState> State
@inject IMapper Mapper
@inject IGenericApiClient<MaintainerDto> MaintainerClient
@inject IGenericApiClient<PlatformDto> PlatformClient
@inject IGenericApiClient<SimulatorDto> SimulatorClient
@inject IGenericApiClient<LotDto> LotClient
@inject IGenericApiClient<ManModuleDto> ManModuleClient
@inject IPlatformApiClient ApiClient

@inject IState<SoftwareState> SoftwareState

<MudGrid>

    @if (_maintainerDtos is not null)
    {
        <MudItem sm="12">
            <CascadingValue Value="@State.Value.MaintainerId">
                <MudChip Color="Color.Primary">Maintainers</MudChip>
                <FSRadio TItem="MaintainerDto" RadioItems="@_maintainerDtos" Context="context" OnSelectedOptionChanged="ChangeMaintainerId">
                    <RadioButtons>
                        <MudRadio Option="@context.Id" Color="Color.Dark" Size="Size.Small">@context.Name</MudRadio>
                    </RadioButtons>
                </FSRadio>
            </CascadingValue>
        </MudItem>
    }
    @if (_platformDtos is not null && State.Value.MaintainerId > 0)
    {
        <MudItem sm="12">
            <MudChip Color="Color.Success">Platforms</MudChip>
            <CascadingValue Value="@State.Value.PlatformId">
                <FSRadio TItem="PlatformDto" RadioItems="@_platformDtos" Context="context" OnSelectedOptionChanged="ChangePlatformId">
                    <RadioButtons>
                        <MudRadio Option="@context.Id" Color="Color.Dark" Size="Size.Small">@context.Name</MudRadio>
                    </RadioButtons>
                </FSRadio>
            </CascadingValue>
        </MudItem>
    }
    @if (_simulatorDtos is not null && State.Value.PlatformId > 0 && State.Value.PlatformId != 7)
    {
        <MudItem sm="12">
            <MudChip Color="Color.Info">Simulators</MudChip>
            <CascadingValue Value="@State.Value.SimulatorId">
                <FSRadio TItem="SimulatorDto" RadioItems="@_simulatorDtos" Context="context" OnSelectedOptionChanged="ChangeSimulatorId">
                    <RadioButtons>
                        <MudRadio Option="@context.Id" Color="Color.Dark" Size="Size.Small">@context.Name</MudRadio>
                    </RadioButtons>
                </FSRadio>
            </CascadingValue>
        </MudItem>
    }
    @if (_lotDtos is not null && State.Value.PlatformId == 7)
    {
        <MudItem sm="12">
            <MudChip Color="Color.Info">Lots</MudChip>
            <CascadingValue Value="@State.Value.LotId">
                <FSRadio TItem="LotDto" RadioItems="@_lotDtos" Context="context" OnSelectedOptionChanged="ChangeLotId">
                    <RadioButtons>
                        <MudRadio Option="@context.Id" Color="Color.Dark" Size="Size.Small">@context.Name</MudRadio>
                    </RadioButtons>
                </FSRadio>
            </CascadingValue>
        </MudItem>
    }
    @if (_manModuleDtos is not null && State.Value.LotId > 0)
    {
        <MudItem sm="12">
            <MudChip Color="Color.Warning">Man Modules</MudChip>
            <CascadingValue Value="@State.Value.ManModuleId">
                <FSRadio TItem="ManModuleDto" RadioItems="@_manModuleDtos" Context="context" OnSelectedOptionChanged="ChangeManModuleId">
                    <RadioButtons>
                        <MudRadio Option="@context.Id" Color="Color.Dark" Size="Size.Small">@context.Name</MudRadio>
                    </RadioButtons>
                </FSRadio>
            </CascadingValue>
        </MudItem>
    }

</MudGrid>

@code {
    //TODO: Change the logic so the RCTD isn't hard coded in ChangePlatformId() method
    private IEnumerable<MaintainerDto>? _maintainerDtos;
    private IEnumerable<PlatformDto>? _platformDtos;
    private IEnumerable<SimulatorDto>? _simulatorDtos;
    private IEnumerable<LotDto>? _lotDtos;
    private IEnumerable<ManModuleDto>? _manModuleDtos;

    private async Task ChangeMaintainerId(int id)
    {
        if (State.Value.MaintainerId != id)
        {
            var action = new MaintainerIdChange { MaintainerModeId = id };
            Dispatcher.Dispatch(action);

            await RefreshPlatforms(id);
        }
    }
    private async Task ChangePlatformId(int id)
    {
        var action = new PlatformIdChange { PlatformModeId = id };
        Dispatcher.Dispatch(action);

        if (id != 7)
        {
            var idChange = new SimulatorIdChange { SimulatorModeId = 0 };
            Dispatcher.Dispatch(idChange);
            await RefreshSimulators(id);
        }

        if (id == 7)
        {
            var idChange = new LotIdChange { LotModeId = 0 };
            Dispatcher.Dispatch(idChange);

            await RefreshLots(id);
        }

        await SetMaintainableId("platform", id);
    }
    private async Task ChangeSimulatorId(int id)
    {
        if (State.Value.SimulatorId != id)
        {
            var action = new SimulatorIdChange { SimulatorModeId = id };
            Dispatcher.Dispatch(action);

            await SetMaintainableId("simulator", id);
        }
    }
    private async Task ChangeLotId(int id)
    {
        if (State.Value.LotId != id)
        {
            var action = new LotIdChange { LotModeId = id };
            Dispatcher.Dispatch(action);

            await RefreshManModules(id);
            await SetMaintainableId("lot", id);
        }
    }
    private async Task ChangeManModuleId(int id)
    {
        if (State.Value.ManModuleId != id)
        {
            var action = new ManModuleIdChange { ManModuleModeId = id };
            Dispatcher.Dispatch(action);

            await SetMaintainableId("mm", id);
        }
    }
    private async Task RefreshPlatforms(int id)
    {
        _platformDtos = await ApiClient.GetPlatformDtosByMaintainerIdAsync(id);

        await RefreshSimulators(0);
    }
    private async Task RefreshLots(int id)
    {
        _lotDtos = await ApiClient.GetLotDtosAsync();
    }
    private async Task RefreshMaintainers()
    {
        _maintainerDtos = await MaintainerClient.GetAllAsync();
    }
    private async Task RefreshSimulators(int id)
    {
        _simulatorDtos = await ApiClient.GetSimulatorDtosByPlatformIdAsync(id);
    }
    private async Task RefreshManModules(int id)
    {
        _manModuleDtos = await ApiClient.GetManModulesByLotIdAsync(id);
    }
    private async Task SetMaintainableId(string table, int id)
    {
        int maintainableId = 0;

        switch (table)
        {
            case "platform":
                var platformDto = await PlatformClient.GetByIdAsync(id);
                maintainableId = platformDto.MaintainableId;
                break;

            case "simulator":
                var simulatorDto = await SimulatorClient.GetByIdAsync(id);
                maintainableId = simulatorDto.MaintainableId;
                break;

            case "lot":
                var lotDto = await LotClient.GetByIdAsync(id);
                maintainableId = lotDto.MaintainableId;
                break;

            case "mm":
                var mmDto = await ManModuleClient.GetByIdAsync(id);
                maintainableId = mmDto.MaintainableId;
                break;
        }
        var action = new MaintainableIdChange { MaintainableModeId = maintainableId };
        Dispatcher.Dispatch(action);
    }

    protected override async Task OnInitializedAsync()
    {
        await RefreshMaintainers();
        if (State.Value.MaintainerId > 0)
        {
            await RefreshPlatforms(State.Value.MaintainerId);
        }
        if (State.Value.PlatformId > 0)
        {
            await RefreshSimulators(State.Value.PlatformId);
            await RefreshLots(State.Value.PlatformId);
        }
        if (State.Value.LotId > 0)
        {
            await RefreshManModules(State.Value.LotId);
        }
    }
}